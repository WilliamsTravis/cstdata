---
title: "Climate Scenario Toolbox"
author: "Travis Williams and Max Joseph"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{cst}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
LOCAL <- identical(Sys.getenv("LOCAL"), "true")
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The use of Global Circulation Models (GCMs) allows resource managers and
researchers to study/plan for possible future climate conditions. The
complexity of the climate system has lead to a large number such GCMs and it is
common practice to examine outputs from many different models at once. Using
methods such as the ensemble mean of these outputs helps to account for
uncertainties inherent in any single model while the outputs of single models
can give an idea of the range of possible future conditions.

The spatial scale of the original outputs of these models is usually quite
coarse (often 1 degree), so several downscaling methods have been developed
to allow for smaller-scale study. One such method is called the Multivariate
Adaptive Climate Analog (MACA). This package uses MACA Version 2 and a
description of the methodology involved may be found
[here](http://www.climatologylab.org/maca.html).

Because the amount of data generated by downscaled GCMs can be quite large
(at least daily time-scales and 2-4 km spatial resolutions), the Climate
Scenarios Toolbox was developed to help users quickly download smaller subsets.
It will also use these subsets in a variety of plotting functions.

Data is acquired from the [Northwest Knowledge Server of the University of
Idaho](http://thredds.northwestknowledge.net:8080/thredds/reacch_climate_CMIP5_macav2_catalog2.html). While this package only accomdates {what are the limits of availability?},
this accounts for ~20 TB of data access. 


## cst

- **Getting started**

Load the cst package and use the reference object within to see the
available argument options for the `cstdata()` function: `models`, `parameters`,
and `scenarios` (as representative concentration pathways).
The `labels` field will spell out the specific meaning of each parameter, the
`variables` field shows the internal variable name of parameters in the data
sets  themselves, and the `units` field shows the measurement unit of each
variable.

```{r references_1, eval = LOCAL}
library(cst)
references <- cst::argument_reference
print(references$models)
print(references$scenarios)
print(references$parameters)
print(references$labels$rhsmax)
print(references$variables$rhsmax)
print(references$units$relative_humidity)
```


Not every GCM has the same set of parameters available, so the
`get_args` method within the reference object will list available information
for each model. 

```{r references_2, eval = LOCAL}
print(references$get_args("CCSM4"))
```

- **Acquiring and subsetting data within National Park Service boundaries**

This package was originally written with the National Park Service in mind, so
it has the option to use the name of any park within the NPS. Use the 
`cstdata()` function to specify a range of years, a set of models, a set of 
parameters, and a set of representative concentration pathways to return. 
Leaving these arguments empty will results in a download of all available data 
for that location.

```{r download_1, eval = LOCAL}
proj_dir <- "."
file_refs <- cstdata(park = "Wind Cave National Park",
                     years = c(1980, 2050),
                     models = NA,
                     parameters = c("tasmin", "vpd"),
                     scenarios = c("rcp45", "rcp85"),
                     local_dir = proj_dir,
                     ncores = 4)
```


- **Acquiring and subsetting data within shapefile boundaries**

You may also specify a shapefile as a local path or as a url to a remote
zipped file. Remote files will downloaded and stored for future use in the
project directory provided to the function.

``` {r download_2, eval = FALSE}
file_refs <- cstdata(park = "Wind Cave National Park",
                     years = c(1980, 2050),
                     models = NA,
                     parameters = c("tasmin", "vpd"),
                     scenarios = c("rcp45", "rcp85"),
                     ncores = 4)
```


## Comparing climate in two time periods

Use the file reference object that is returned from cst as an input to
`compare_periods` to compare climate between a reference and target period. You
may specify the function with which to aggregate your chosen variable as well
as the yearly time period months of the year to include in this calculation.

```{r scatterplot, eval = LOCAL}
comps <- compare_periods(file_refs,
                         var1 = "tasmin",
                         var2 = "vpd",
                         agg_fun = "mean",
                         target_period = c(2020, 2050),
                         reference_period = c(1990, 2019),
                         months1 = c(1, 2, 3),
                         months2 = c(4, 5, 6),
                         scenarios = c("rcp45", "rcp85"))
```

## boxplot
``` {r boxplot, eval = LOCAL}
```

## timeseries
``` {r timeseries, eval = LOCAL}

```

## raw_data
``` {r raw data, eval = LOCAL}
```